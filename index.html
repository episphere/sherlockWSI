<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSI Heatmap Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/openseadragon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/episphere/GeoTIFFTileSource-JPEG2k/GeoTIFFTileSource.js" type="module" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gray-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-2xl font-bold">WSI Heatmap Viewer</h1>
            <div class="relative">
                <select id="image-select" class="appearance-none bg-primary-600 hover:bg-primary-700 text-white py-2 px-4 pr-8 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-opacity-50">
                    <option value="" disabled selected>Select Image</option>
                    <!-- Options will be populated dynamically -->
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M7 7l3-3 3 3m0 6l-3 3-3-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
                    </svg>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <div class="w-sm border-r border-gray-200 bg-white shadow-md">
            <div class="flex flex-col h-full">
                <div class="p-4 flex flex-col flex-1">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2 text-center">Heatmap Navigator</h2>
                    <div id="heatmap-navigator" class="flex-1 bg-gray-100 rounded-lg border border-gray-300 shadow-inner mb-4"></div>
                </div>
                <div id="class-selector" class="p-3 border-t border-gray-200 bg-gray-50 flex gap-2 overflow-x-auto whitespace-nowrap">
                    <!-- Class buttons will be populated dynamically -->
                </div>
            </div>
        </div>
        
        <!-- Main View -->
        <div class="flex-1 relative">
            <div id="slide-viewer" class="w-full h-full"></div>
        </div>
    </div>

    <script>
        // Sample data from your provided JSON
        const imageMappings = {
    "gcsBaseFolder": "301f394c-ea68-4a26-829b-88208fffb5c6",
    "images": [
        {
            "id": "Slide-0027581_2391-CTT-01753-07.ndpi",
            "fileName": "Slide-0027581_2391-CTT-01753-07.tif",
            "slideName": "Slide-0027581_2391-CTT-01753-07.ndpi",
            "predictionImages": [
                {
                    "classId": "10",
                    "image": "Slide-0027581_2391-CTT-01753-07_heatmap_ALK_resized.png"
                },
                {
                    "classId": "9",
                    "image": "Slide-0027581_2391-CTT-01753-07_heatmap_MDM2_resized.png"
                },
                {
                    "classId": "11",
                    "image": "Slide-0027581_2391-CTT-01753-07_heatmap_WGD_resized.png"
                },
                {
                    "classId": "18",
                    "image": "Slide-0027581_2391-CTT-01753-07_heatmap_No-APOBEC_resized.png"
                }
            ]
        },
        {
            "id": "Slide-0629697_G_9452_60362 t1-3.svs",
            "fileName": "Slide-0629697_G_9452_60362 t1-3.svs",
            "slideName": "Slide-0629697_G_9452_60362 t1-3.svs",
            "predictionImages": [
                {
                    "classId": "12",
                    "image": "Slide-0629697_G_9452_60362 t1-3_heatmap_Kataegis_resized.png"
                },
                {
                    "classId": "11",
                    "image": "Slide-0629697_G_9452_60362 t1-3_heatmap_WGD_Status_resized.png"
                }
            ]
        },
        {
            "id": "Slide-0629783_G_10823_59159 T12.svs",
            "fileName": "Slide-0629783_G_10823_59159 T12.svs",
            "slideName": "Slide-0629783_G_10823_59159 T12.svs",
            "predictionImages": [
                {
                    "classId": "12",
                    "image": "Slide-0629783_G_10823_59159 T12_heatmap_Kataegis_resized.png"
                },
                {
                    "classId": "18",
                    "image": "Slide-0629783_G_10823_59159 T12_heatmap_No-APOBEC_resized.png"
                },
                {
                    "classId": "19",
                    "image": "Slide-0629783_G_10823_59159 T12_heatmap_No-WGD_resized.png"
                }
            ]
        },
        {
            "id": "Slide-0000931_GS01714 0214.ndpi",
            "fileName": "Slide-0000931_GS01714 0214.tif",
            "slideName": "Slide-0000931_GS01714 0214.ndpi",
            "predictionImages": [
                {
                    "classId": "6",
                    "image": "Slide-0000931_GS01714 0214_heatmap_TP53_resized.png"
                },
                {
                    "classId": "4",
                    "image": "Slide-0000931_GS01714 0214_heatmap_EGFR_resized.png"
                },
                {
                    "classId": "2",
                    "image": "Slide-0000931_GS01714 0214_heatmap_RBM10_resized.png"
                }
            ]
        },
        {
            "id": "Slide-0738001_CTT00618-07-13_1023073.svs",
            "fileName": "Slide-0738001_CTT00618-07-13_1023073.svs",
            "slideName": "Slide-0738001_CTT00618-07-13_1023073.svs",
            "predictionImages": [
                {
                    "classId": "15",
                    "image": "Slide-0738001_CTT00618-07-13_1023073_heatmap_KRAS p12C-WT_resized.png"
                },
                {
                    "classId": "14",
                    "image": "Slide-0738001_CTT00618-07-13_1023073_heatmap_EGFR p.E746_A750del_resized.png"
                }
            ]
        },
        {
            "id": "Slide-0748899_CTT04028-10-13_1023095.svs",
            "fileName": "Slide-0748899_CTT04028-10-13_1023095.svs",
            "slideName": "Slide-0748899_CTT04028-10-13_1023095.svs",
            "predictionImages": [
                {
                    "classId": "6",
                    "image": "Slide-0748899_CTT04028-10-13_1023095_heatmap_TP53_resized.png"
                },
                {
                    "classId": "4",
                    "image": "Slide-0748899_CTT04028-10-13_1023095_heatmap_EGFR_resized.png"
                },
                {
                    "classId": "14",
                    "image": "Slide-0748899_CTT04028-10-13_1023095_heatmap_EGFR p.E746_A750del_resized.png"
                }
            ]
        },
        {
            "id": "Slide-0027629_3917-CTT-04028-10.ndpi",
            "fileName": "Slide-0027629_3917-CTT-04028-10.tif",
            "slideName": "Slide-0027629_3917-CTT-04028-10.ndpi",
            "predictionImages": [
                {
                    "classId": "6",
                    "image": "Slide-0027629_3917-CTT-04028-10_heatmap_TP53_resized.png"
                },
                {
                    "classId": "4",
                    "image": "Slide-0027629_3917-CTT-04028-10_heatmap_EGFR_resized.png"
                },
                {
                    "classId": "14",
                    "image": "Slide-0027629_3917-CTT-04028-10_heatmap_EGFR p.E746_A750del_resized.png"
                }
            ]
        }
    ]
}

        const classMappings = [
    {
        "id": "1",
        "name": "TMB",
        "displayName": "TMB"
    },
    {
        "id": "2",
        "name": "RBM10",
        "displayName": "RBM10"
    },
    {
        "id": "3",
        "name": "KRAS",
        "displayName": "KRAS"
    },
    {
        "id": "4",
        "name": "EGFR",
        "displayName": "EGFR"
    },
    {
        "id": "5",
        "name": "EGFR_p_L858R",
        "displayName": "EGFR p.L858R"
    },
    {
        "id": "6",
        "name": "TP53",
        "displayName": "TP53"
    },
    {
        "id": "7",
        "name": "CDKN2A_deletion",
        "displayName": "CDKN2A Deletion"
    },
    {
        "id": "8",
        "name": "Risk_survival",
        "displayName": "Risk-Survival"
    },
    {
        "id": "9",
        "name": "MDM2_amplification",
        "displayName": "MDM2 Amplification"
    },
    {
        "id": "10",
        "name": "ALK_fusion",
        "displayName": "ALK Fusion"
    },
    {
        "id": "11",
        "name": "WGD_Status",
        "displayName": "WGD Status"
    },
    {
        "id": "12",
        "name": "Kataegis",
        "displayName": "Kataegis"
    },
    {
        "id": "13",
        "name": "APOBEC",
        "displayName": "APOBEC"
    },
    {
        "id": "14",
        "name": "EGFR_p_E746_A750del",
        "displayName": "EGFR p.E746_A750del"
    },
    {
        "id": "15",
        "name": "KRAS_p_G12C",
        "displayName": "KRAS p.G12C"
    },
    {
        "id": "16",
        "name": "KRAS_p_G12V",
        "displayName": "KRAS p.G12V"
    },
    {
        "id": "17",
        "name": "KRAS_p_G12D",
        "displayName": "KRAS p.G12D"
    },
    {
        "id": "18",
        "name": "Negative_APOBEC",
        "displayName": "[Negative] APOBEC"
    },
    {
        "id": "19",
        "name": "Negative_WGD",
        "displayName": "[Negative] WGD"
    }
]

        // Get class colors - using consistent colors based on class ID
        function getClassColor(classId) {
            const colors = {
                "1": "rgba(239, 68, 68, 0.7)",    // red
                "2": "rgba(59, 130, 246, 0.7)",   // blue
                "3": "rgba(16, 185, 129, 0.7)",   // green
                "4": "rgba(217, 119, 6, 0.7)",    // amber
                "5": "rgba(139, 92, 246, 0.7)"    // purple
            };
            return colors[classId] || "rgba(107, 114, 128, 0.7)"; // gray fallback
        }

        // Global variables
        let viewer;
        let navigatorViewer;
        let currentSlideImage;
        let currentHeatmapImage;
        
        // Initialize the page
        function init() {
            populateImageSelect();
            
            // Initialize main viewer
            viewer = OpenSeadragon({
                id: "slide-viewer",
                prefixUrl:  "https://episphere.github.io/svs/openseadragon/images/",
                showNavigator: false,
                animationTime: 0.3,
                blendTime: 0.1,
                constrainDuringPan: true,
                visibilityRatio: 1,
                minZoomImageRatio: 1,
                crossOriginPolicy: "Anonymous",
                sequenceMode: false
                // maxZoomPixelRatio: 2
            });
            
            // Initialize navigator viewer (for heatmaps)
            navigatorViewer = OpenSeadragon({
                id: "heatmap-navigator",
                prefixUrl: "https://cdnjs.cloudflare.com/ajax/libs/openseadragon/4.1.0/images/",
                showNavigationControl: false,
                showNavigator: false,
                constrainDuringPan: true,
                visibilityRatio: 1,
                minZoomImageRatio: 1,
            });
            
            // Add event listener to sync navigatorViewer with main viewer
            viewer.addHandler('animation', function() {
                syncNavigatorWithViewer();
            });

            // Handle image selection change
            document.getElementById('image-select').addEventListener('change', function() {
                const selectedImageId = this.value;
                if (selectedImageId) {
                    loadSlideImage(selectedImageId);
                }
            });
        }
        
        // Populate the image select dropdown
        function populateImageSelect() {
            const select = document.getElementById('image-select');
            
            imageMappings.images.forEach(image => {
                const option = document.createElement('option');
                option.value = image.id;
                option.textContent = image.slideName;
                select.appendChild(option);
            });
        }
        
        // Load a slide image and its available heatmaps
        async function loadSlideImage(imageId) {
            // Find the selected image data
            const imageData = imageMappings.images.find(img => img.id === imageId);
            if (!imageData) return;
            
            // Clear previous data
            clearClassSelector();
            
            // In a real application, this would be the path to your image
            // For this example, we'll use a placeholder
            const url = `https://storage.googleapis.com/sherlock_wsi/${imageMappings.gcsBaseFolder}/${imageData.fileName}`
            const tileSource = await OpenSeadragon.GeoTIFFTileSource.getAllTileSources(url, {logLatency: false, cache: false});;
            
            // Load the slide image into the main viewer
            viewer.open(tileSource);
            
            currentSlideImage = imageData;
            
            // Populate class selector with available prediction images
            populateClassSelector(imageData.predictionImages);
            
            // Select the first heatmap by default if available
            if (imageData.predictionImages.length > 0) {
                selectHeatmap(imageData.predictionImages[0].classId);
            }
        }
        
        // Populate the class selector with buttons for each available heatmap
        function populateClassSelector(predictionImages) {
            const classSelector = document.getElementById('class-selector');
            
            predictionImages.forEach(prediction => {
                const classInfo = classMappings.find(cls => cls.id === prediction.classId);
                if (!classInfo) return;
                
                const button = document.createElement('button');
                button.className = 'px-3 py-2 rounded-md text-white font-medium text-sm transition-all';
                button.style.backgroundColor = getClassColor(prediction.classId);
                button.dataset.classId = prediction.classId;
                button.textContent = classInfo.displayName;
                
                button.addEventListener('click', function() {
                    // Update active state for all buttons
                    document.querySelectorAll('[data-class-id]').forEach(btn => {
                        btn.classList.remove('ring-2', 'ring-gray-100', 'ring-offset-1', 'shadow-lg');
                        btn.classList.add('opacity-80');
                    });
                    
                    // Add active class to clicked button
                    this.classList.add('ring-2', 'ring-gray-100', 'ring-offset-1', 'shadow-lg');
                    this.classList.remove('opacity-80');
                    
                    // Load the selected heatmap
                    selectHeatmap(prediction.classId);
                });
                
                // Add opacity effect for non-selected buttons
                button.classList.add('opacity-80');
                
                classSelector.appendChild(button);
            });
        }
        
        // Clear the class selector
        function clearClassSelector() {
            const classSelector = document.getElementById('class-selector');
            classSelector.innerHTML = '';
        }
        
        // Select and load a specific heatmap
        function selectHeatmap(classId) {
            if (!currentSlideImage) return;
            
            // Find the prediction image for the selected class
            const predictionImage = currentSlideImage.predictionImages.find(pred => pred.classId === classId);
            const predictedClass = classMappings.find(cls => cls.id === classId)
            if (!predictionImage) return;
            
            // Mark the corresponding button as active
            document.querySelectorAll('[data-class-id]').forEach(btn => {
                if (btn.dataset.classId === classId) {
                    btn.classList.add('ring-2', 'ring-gray-100', 'ring-offset-1', 'shadow-lg');
                    btn.classList.remove('opacity-80');
                } else {
                    btn.classList.remove('ring-2', 'ring-gray-100', 'ring-offset-1', 'shadow-lg');
                    btn.classList.add('opacity-80');
                }
            });
            
            // In a real application, this would be the path to your heatmap image
            // For this example, we'll use a placeholder with color tint based on classId
            const heatmapImageUrl = `https://storage.googleapis.com/sherlock_wsi/${imageMappings.gcsBaseFolder}/${predictedClass.name}/${predictionImage.image}`;
            
            // Load the heatmap into the navigator viewer
            navigatorViewer.open({
                type: 'image',
                url: heatmapImageUrl,
                buildPyramid: true
            });
            
            currentHeatmapImage = predictionImage;
            
            // Apply color filter based on class ID to differentiate heatmaps
            setTimeout(() => {
                const tileSource = navigatorViewer.world.getItemAt(0);
                if (tileSource) {
                    const classColor = getClassColor(classId);
                    tileSource.setStyle({
                        filter: `opacity(0.8) sepia(1) hue-rotate(${parseInt(classId) * 60}deg) saturate(2)`
                    });
                }
                
                // Initial sync of navigator with main viewer
                syncNavigatorWithViewer();
            }, 100);
        }
        
        // Synchronize the navigator viewer with the main viewer's viewport
        function syncNavigatorWithViewer() {
            if (!viewer || !navigatorViewer) return;
            
            const viewport = viewer.viewport;
            const navViewport = navigatorViewer.viewport;
            
            if (viewport && navViewport) {
                // Update the navigator viewport to match the main viewer
                navViewport.zoomTo(viewport.getZoom());
                navViewport.panTo(viewport.getCenter());
            }
        }
        
        // Initialize the application
        window.onload = init;
    </script>
</body>
</html>